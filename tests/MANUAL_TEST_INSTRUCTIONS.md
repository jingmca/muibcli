# 手动测试说明 - Quote持仓信息和PNL颜色功能

**测试状态**: ✅ 代码就绪，等待实际环境验证

---

## ✅ 已完成的准备工作

- [x] 阶段1：代码审查 ✅
- [x] 阶段2：单元测试 ✅ (20/20测试通过)
- [x] 阶段3：清理Python缓存 ✅
- [x] 阶段4：环境准备 ✅ (安装socksio依赖)
- [ ] 阶段5：**手动CLI测试** ⏳ (需要你执行)

---

## 🔧 代码验证状态

### 已确认的代码修改：

1. **icli/cli.py** - 持仓信息显示
   - ✅ Line 4074-4083: 持仓数量和成本获取逻辑
   - ✅ Line 4679, 4888: 持仓显示格式化 `[Pos:±数量@成本]`
   - ✅ Line 4607-4617: ITM期权检测和绿色高亮

2. **icli/cmds/portfolio/positions.py** - PNL颜色
   - ✅ Line 40-65: `_format_pnl_with_color()` 方法
   - ✅ Line 151: PNL列应用颜色格式化

3. **依赖安装**
   - ✅ socksio (1.0.0) 已安装（解决SOCKS代理问题）

---

## 🚀 现在请你执行手动测试

### 第1步：启动tmux会话

```bash
# 创建新的tmux会话
tmux new -s icli-test

# 或连接到现有会话
tmux attach -t icli-test
```

### 第2步：分割窗格查看日志

```bash
# 在tmux中按下：
Ctrl+b %        # 垂直分割窗格

# 在右侧窗格查看日志
tail -f runlogs/2025/11/icli-*.log

# 切换回左侧窗格
Ctrl+b o
```

### 第3步：启动icli

```bash
# 在左侧窗格启动icli（连接到4001正式环境）
ICLI_IBKR_PORT=4001 ICLI_IBKR_ACCOUNT_ID=U9619867 poetry run icli
```

### 第4步：执行测试命令序列

#### A. 基础功能测试

```bash
# 1. 查看当前持仓
positions

# 期待结果：
# - PNL列应该显示红色（亏损）或绿色（盈利）
# - 盈利/亏损金额应该有颜色强度差异
```

#### B. 报价区持仓信息测试

```bash
# 2. 找一个有持仓的标的（从positions输出中选择）
# 假设你有AAPL持仓，执行：
add AAPL

# 期待结果：
# - AAPL行情行尾应该显示：[Pos:+100@150.50] （示例格式）
# - 多头显示+号，空头显示-号
# - 成本价格正确
# - 显示为加粗

# 3. 添加没有持仓的标的
add SPY

# 期待结果：
# - SPY行情正常显示
# - 但不显示持仓信息（因为没有持仓）
```

#### C. 期权ITM测试

```bash
# 4. 添加期权行情（替换为实际可用的期权）
add AAPL251121C00265000

# 期待结果（假设AAPL当前价格是270）：
# - 显示 [u 270.50 ITM] （绿色背景的ITM）
# - ITM标记只在价内时显示
# - Call: underlying >= strike 显示ITM
# - Put: underlying <= strike 显示ITM
```

#### D. 不同预设模式测试

```bash
# 5. 切换不同的quote preset
display quote.preset minimal
# 观察：持仓信息应该显示

display quote.preset compact
# 观察：持仓信息应该显示

display quote.preset trading
# 观察：持仓信息应该显示

display quote.preset options
# 观察：持仓信息应该显示
```

#### E. PNL颜色强度测试

查看positions输出，验证颜色强度：

```
期待的颜色规则：
盈利：
  - $0-$1,000: 绿色文字
  - $1,000-$10,000: 绿色背景
  - >$10,000: 亮绿色背景

亏损：
  - $0-$1,000: 红色文字
  - $1,000-$10,000: 红色背景
  - >$10,000: 亮红色背景

零值：灰色
```

---

## 📋 测试检查清单

完成测试后，请确认以下各项：

### 报价区持仓信息
- [ ] 持仓标的显示 `[Pos:±数量@成本]`
- [ ] 多头显示+号
- [ ] 空头显示-号（如果有）
- [ ] 成本价格准确
- [ ] 无持仓标的不显示
- [ ] 所有preset模式都支持

### ITM期权提示
- [ ] Call期权价内时显示绿色ITM
- [ ] Put期权价内时显示绿色ITM
- [ ] 价外期权不显示ITM
- [ ] ITM标记为绿色背景

### PNL颜色显示
- [ ] 盈利显示绿色
- [ ] 亏损显示红色
- [ ] 颜色强度正确
- [ ] Total行也显示颜色

### 回归测试
- [ ] positions命令正常
- [ ] add/remove命令正常
- [ ] 其他功能未受影响
- [ ] 无异常错误

---

## 🐛 如果发现问题

请记录以下信息：

1. **问题描述**：具体什么不对
2. **执行的命令**：完整命令
3. **期待结果**：应该是什么
4. **实际结果**：实际看到什么
5. **日志信息**：右侧窗格的相关日志
6. **截图**（如果可能）

---

## ✅ 测试通过后

如果所有测试都通过，请告诉我，然后我们可以：

1. 创建git commit
2. 更新文档
3. 标记功能完成

---

**为什么需要手动测试？**

icli使用prompt-toolkit，需要真实的TTY终端才能运行。无法通过脚本自动化测试交互式命令行界面。因此必须在tmux或真实终端中手动验证功能。

**祝测试顺利！** 🎉
