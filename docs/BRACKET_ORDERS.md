# 止盈止损订单详解 (Bracket Orders)

## 概述

止盈止损订单（Bracket Orders）是一种同时设置盈利目标和风险控制的订单策略。ICLI提供简洁的语法来创建包含止盈和止损的订单组合，帮助交易者自动管理风险和收益。

## 基础概念

### 什么是Bracket Order？

Bracket Order由三个订单组成：
1. **主订单（Parent）** - 入场订单（买入或卖出）
2. **止盈订单（Profit Target）** - 到达目标价格时获利了结
3. **止损订单（Stop Loss）** - 价格不利时限制损失

### 工作原理

```
买入示例：
主订单：buy AAPL 100 @ 150
止盈：sell AAPL 100 @ 155  ← 价格上涨到155时卖出
止损：sell AAPL 100 @ 145  ← 价格下跌到145时卖出

执行逻辑：
1. 主订单成交后，止盈和止损订单自动激活
2. 止盈或止损任一成交，另一个自动取消
3. 确保仓位完全平仓
```

## ICLI语法

### 简洁语法（±符号）

```bash
# 基础语法
buy <symbol> <qty> <type> @ <price> ± <distance>
#                                   ^^^^^^^^^^^
#                                   止盈止损距离

# 示例
buy AAPL 100 AF @ 150 ± 5
# 止盈：155（150 + 5）
# 止损：145（150 - 5）
```

### 完整语法（方括号）

```bash
# 完整语法
buy <symbol> <qty> <type> @ <price> [profit:<price>] [stop:<price>]

# 示例：不对称止盈止损
buy AAPL 100 AF @ 150 [profit:157] [stop:147]
# 止盈：157（+7）
# 止损：147（-3）
# 盈亏比：7:3 = 2.33:1
```

### 仅止损或仅止盈

```bash
# 仅止损
buy AAPL 100 AF @ 150 [stop:145]

# 仅止盈
buy AAPL 100 AF @ 150 [profit:155]

# 灵活组合
buy AAPL 100 AF @ 150 ± 3  # 对称
buy AAPL 100 AF @ 150 [profit:155]  # 仅止盈
buy AAPL 100 AF @ 150 [stop:147]  # 仅止损
```

## 订单类型支持

### 主订单类型

所有入场订单类型都支持止盈止损：

| 主订单类型 | 支持 | 示例 |
|-----------|------|------|
| AF | ✅ | `buy AAPL 100 AF @ 150 ± 5` |
| LMT | ✅ | `buy AAPL 100 LMT @ 150 ± 5 GTC` |
| MID | ✅ | `buy AAPL 100 MID ± 5` |
| MKT | ✅ | `buy AAPL 100 MKT ± 5` |
| REL | ✅ | `buy AAPL 100 REL @ -0.01 ± 5` |

### 止盈订单类型

止盈订单通常使用限价单（LMT）：

```bash
buy AAPL 100 AF @ 150 ± 5
# 止盈自动生成：
# sell AAPL 100 LMT @ 155 GTC
```

### 止损订单类型

止损订单可以使用不同类型：

```bash
# 标准止损（止损市价单）
buy AAPL 100 AF @ 150 [stop:145]
# 生成：sell AAPL 100 STP @ 145 GTC

# 止损限价单（控制滑点）
buy AAPL 100 AF @ 150 [stop:145 limit:144]
# 生成：sell AAPL 100 STPLMT @ 145:144 GTC

# 跟踪止损
buy AAPL 100 AF @ 150 [trail:3]
# 生成：sell AAPL 100 TRAIL @ 3.00 GTC
```

## 实战示例

### 示例1：日内快速交易（对称止盈止损）

```bash
# 场景：日内突破交易，快速进出
buy SPY 100 AF @ 450 ± 2

# 自动生成：
# 1. buy SPY 100 AF @ 450        ← 主订单（AF快速成交）
# 2. sell SPY 100 LMT @ 452 GTC   ← 止盈（+2）
# 3. sell SPY 100 STP @ 448 GTC   ← 止损（-2）

# 结果：
# 盈亏比 1:1
# 最大收益：$200
# 最大损失：$200
```

### 示例2：波段交易（不对称止盈止损）

```bash
# 场景：支撑位买入，看涨
buy AAPL 500 LMT @ 145 [profit:155] [stop:142] GTC RTH

# 自动生成：
# 1. buy AAPL 500 LMT @ 145 GTC RTH    ← 主订单
# 2. sell AAPL 500 LMT @ 155 GTC RTH   ← 止盈（+10，+6.9%）
# 3. sell AAPL 500 STP @ 142 GTC       ← 止损（-3，-2.1%）

# 结果：
# 盈亏比 10:3 = 3.33:1
# 最大收益：$5,000
# 最大损失：$1,500
```

### 示例3：小止损大止盈（高盈亏比）

```bash
# 场景：突破策略，期待大行情
buy NVDA 100 AF @ 500 [profit:520] [stop:497]

# 自动生成：
# 1. buy NVDA 100 AF @ 500        ← 快速入场
# 2. sell NVDA 100 LMT @ 520 GTC   ← 止盈（+20，+4%）
# 3. sell NVDA 100 STP @ 497 GTC   ← 止损（-3，-0.6%）

# 结果：
# 盈亏比 20:3 = 6.67:1
# 最大收益：$2,000
# 最大损失：$300
```

### 示例4：仅止损保护

```bash
# 场景：看好长期，只设止损
buy TSLA 200 LMT @ 250 [stop:240] GTC RTH

# 自动生成：
# 1. buy TSLA 200 LMT @ 250 GTC RTH  ← 主订单
# 2. sell TSLA 200 STP @ 240 GTC     ← 止损（-10，-4%）

# 结果：
# 止盈：手动管理或不设限
# 止损：自动保护，最大损失$2,000
```

### 示例5：跟踪止损（锁定利润）

```bash
# 场景：已有盈利，锁定利润
buy AAPL 100 AF @ 150 [trail:5]

# 自动生成：
# 1. buy AAPL 100 AF @ 150            ← 主订单
# 2. sell AAPL 100 TRAIL @ 5.00 GTC   ← 跟踪止损（-5）

# 工作原理：
# 价格涨到155 → 止损自动提升到150（保本）
# 价格涨到160 → 止损自动提升到155（+5利润）
# 价格涨到165 → 止损自动提升到160（+10利润）
# 价格跌回160 → 自动卖出（锁定+10利润）
```

## 盈亏比策略

### 什么是盈亏比？

盈亏比 = 潜在收益 / 潜在损失

```bash
buy AAPL 100 @ 150 [profit:160] [stop:145]

盈亏比 = (160-150) / (150-145) = 10 / 5 = 2:1
```

### 推荐盈亏比

| 交易风格 | 推荐盈亏比 | 胜率要求 | 示例 |
|---------|----------|---------|------|
| 日内交易 | 1:1 到 2:1 | 50%+ | `± 2` 或 `[profit:+4] [stop:-2]` |
| 波段交易 | 2:1 到 4:1 | 40%+ | `[profit:+8] [stop:-2]` |
| 趋势跟随 | 3:1 到 5:1+ | 30%+ | `[profit:+15] [stop:-3]` |

### 盈亏比计算器

```bash
# 对称 1:1
buy AAPL 100 @ 150 ± 5
# 盈亏比：1:1（需要50%胜率盈亏平衡）

# 不对称 2:1
buy AAPL 100 @ 150 [profit:+10] [stop:-5]
# 盈亏比：2:1（需要33%胜率盈亏平衡）

# 不对称 3:1
buy AAPL 100 @ 150 [profit:+15] [stop:-5]
# 盈亏比：3:1（需要25%胜率盈亏平衡）

# 不对称 5:1
buy AAPL 100 @ 150 [profit:+20] [stop:-4]
# 盈亏比：5:1（需要17%胜率盈亏平衡）
```

### 盈亏比策略选择

#### 高胜率策略（1:1 到 1.5:1）
```bash
# 适合：
# - 均值回归策略
# - 支撑阻力交易
# - 高胜率技术形态

# 示例
buy AAPL 100 @ 150 ± 3  # 1:1盈亏比
```

#### 平衡策略（2:1 到 3:1）
```bash
# 适合：
# - 趋势跟随
# - 突破交易
# - 波段交易

# 示例
buy AAPL 100 @ 150 [profit:+6] [stop:-3]  # 2:1盈亏比
```

#### 高盈亏比策略（4:1+）
```bash
# 适合：
# - 趋势初期入场
# - 小止损大目标
# - 低胜率高回报

# 示例
buy AAPL 100 @ 150 [profit:+20] [stop:-5]  # 4:1盈亏比
```

## 止损类型选择

### 1. 固定止损（最常用）

```bash
buy AAPL 100 AF @ 150 [stop:145]

# 特点：
# ✅ 简单直接
# ✅ 风险明确
# ✅ 适合大多数场景
```

### 2. 止损限价单（控制滑点）

```bash
buy AAPL 100 AF @ 150 [stop:145 limit:144]

# 特点：
# ✅ 控制最大滑点
# ✅ 避免极端价格成交
# ⚠️  可能不成交，风险更大
```

### 3. 跟踪止损（锁定利润）

```bash
buy AAPL 100 AF @ 150 [trail:5]

# 特点：
# ✅ 自动跟随价格上涨
# ✅ 锁定盈利
# ✅ 给利润空间增长
# ⚠️  可能过早止损
```

### 4. 百分比止损

```bash
buy AAPL 100 AF @ 150 [stop:-2%]

# 等同于：
buy AAPL 100 AF @ 150 [stop:147]  # 150 * (1 - 0.02)

# 特点：
# ✅ 适应不同价格股票
# ✅ 风险百分比一致
```

## 止损位置设定

### 技术位止损（推荐）

```bash
# 基于支撑位
buy AAPL 100 @ 150 [stop:145]
#                         ^^^ 支撑位145下方

# 基于近期低点
buy SPY 100 @ 450 [stop:447]
#                        ^^^ 近期低点448下方

# 基于ATR（平均真实波幅）
# 假设AAPL的ATR = 3
buy AAPL 100 @ 150 [stop:147]  # 1 ATR止损
buy AAPL 100 @ 150 [stop:144]  # 2 ATR止损
```

### 固定金额止损

```bash
# 风险$500
buy AAPL 100 @ 150 [stop:145]
# 100股 × $5 = $500风险

# 风险$1000
buy AAPL 200 @ 150 [stop:145]
# 200股 × $5 = $1000风险
```

### 百分比止损

```bash
# 1%止损（保守）
buy AAPL 100 @ 150 [stop:148.5]  # 150 × 0.99

# 2%止损（常用）
buy AAPL 100 @ 150 [stop:147]    # 150 × 0.98

# 3%止损（激进）
buy AAPL 100 @ 150 [stop:145.5]  # 150 × 0.97

# 5%止损（波段）
buy AAPL 100 @ 150 [stop:142.5]  # 150 × 0.95
```

## 订单管理

### 查看Bracket订单

```bash
# 查看所有活跃订单
orders

# 输出示例：
# Order ID  Symbol  Type    Qty  Price   Status
# 123       AAPL    BUY     100  150.00  Filled
# 124       AAPL    SELL    100  155.00  Submitted  ← 止盈
# 125       AAPL    STP     100  145.00  Submitted  ← 止损
```

### 修改止盈止损

```bash
# 方式1：取消原订单，重新提交
cancel 124  # 取消止盈
sell AAPL 100 LMT @ 157 GTC  # 新止盈

# 方式2：使用modify命令
modify 124  # 交互式修改订单价格
```

### 手动平仓

```bash
# 取消止盈止损，手动平仓
cancel 124 125  # 取消止盈和止损
sell AAPL 100 MKT  # 市价平仓

# 或使用evict命令
evict AAPL 0 0 MKT  # 清空AAPL仓位
```

### 移动止损

```bash
# 场景：价格涨到155，移动止损到保本
# 原止损：145
# 新止损：150（保本）

cancel 125  # 取消原止损
sell AAPL 100 STP @ 150 GTC  # 新止损在保本位
```

## 高级技巧

### 1. 分批止盈

```bash
# 主订单
buy AAPL 300 AF @ 150

# 分三批止盈
sell AAPL 100 LMT @ 153 GTC  # 第一批（+3）
sell AAPL 100 LMT @ 156 GTC  # 第二批（+6）
sell AAPL 100 LMT @ 160 GTC  # 第三批（+10）

# 统一止损
sell AAPL 300 STP @ 145 GTC  # 全部（-5）

# 优势：
# ✅ 部分获利，降低风险
# ✅ 剩余仓位追求更大收益
# ✅ 平均止盈更优化
```

### 2. 移动止损策略

```bash
# 1. 初始入场
buy AAPL 100 AF @ 150 [stop:145]

# 2. 价格涨到155，移动止损到保本
cancel <stop_order_id>
sell AAPL 100 STP @ 150 GTC

# 3. 价格涨到160，移动止损锁定利润
cancel <stop_order_id>
sell AAPL 100 STP @ 155 GTC

# 4. 价格涨到165，继续移动止损
cancel <stop_order_id>
sell AAPL 100 STP @ 160 GTC

# 或直接使用跟踪止损：
buy AAPL 100 AF @ 150 [trail:5]  # 自动移动
```

### 3. 时间止损

```bash
# 场景：日内交易，收盘前平仓
buy SPY 100 AF @ 450 [stop:448] DAY

# DAY订单自动在收盘前取消，避免过夜
# 如果止损未触发，收盘前手动平仓
```

### 4. 条件止损

```bash
# 使用ifthen系统设置复杂条件
# 示例：如果SPY跌破450，平掉AAPL仓位
if SPY last < 450: evict AAPL 0 0 MKT
```

### 5. 金字塔式建仓带止损

```bash
# 第一笔：初始仓位
buy AAPL 100 AF @ 150 [stop:145]

# 价格涨到153，加仓
buy AAPL 100 AF @ 153 [stop:150]

# 价格涨到156，再加仓
buy AAPL 100 AF @ 156 [stop:153]

# 结果：
# 总仓位：300股
# 平均成本：153
# 保护止损：153（平均保本）
```

## 常见错误和避免方法

### 错误1：止损位置太近

```bash
# ❌ 错误：止损太紧，容易被噪音触发
buy AAPL 100 @ 150 [stop:149.5]  # 仅-0.5，太紧

# ✅ 正确：给价格波动空间
buy AAPL 100 @ 150 [stop:147]    # -3，合理（ATR基础）
```

### 错误2：止损位置太远

```bash
# ❌ 错误：止损太远，风险过大
buy AAPL 100 @ 150 [stop:130]    # -20，-13%，太大

# ✅ 正确：控制风险在可接受范围
buy AAPL 100 @ 150 [stop:145]    # -5，-3%，合理
```

### 错误3：盈亏比不合理

```bash
# ❌ 错误：止损大于止盈（负盈亏比）
buy AAPL 100 @ 150 [profit:153] [stop:145]  # 3:5 = 0.6:1

# ✅ 正确：止盈大于止损
buy AAPL 100 @ 150 [profit:160] [stop:147]  # 10:3 = 3.33:1
```

### 错误4：忘记设置止损

```bash
# ❌ 错误：没有止损保护
buy AAPL 100 AF @ 150

# ✅ 正确：始终设置止损
buy AAPL 100 AF @ 150 [stop:145]
```

### 错误5：频繁移动止损

```bash
# ❌ 错误：价格接近止损就移动，永远止损
buy AAPL 100 @ 150 [stop:145]
# 价格跌到145.5...
# 移动止损到142  ← 错误！破坏计划

# ✅ 正确：严格执行预设止损
buy AAPL 100 @ 150 [stop:145]
# 145触发，执行止损  ← 正确！
```

## 风险管理原则

### 1. 单笔风险控制

```bash
# 原则：单笔交易风险≤账户的1-2%

# 假设账户：$100,000
# 风险容忍：1% = $1,000

# 计算：
# 止损距离：$5 (150 - 145)
# 最大股数：$1,000 / $5 = 200股

buy AAPL 200 @ 150 [stop:145]
# 风险：200 × $5 = $1,000 ✅
```

### 2. 总持仓风险控制

```bash
# 原则：总持仓风险≤账户的5-10%

# 假设账户：$100,000
# 最大风险：5% = $5,000

# 持仓1：
buy AAPL 200 @ 150 [stop:145]  # 风险$1,000

# 持仓2：
buy SPY 40 @ 450 [stop:440]    # 风险$400

# 持仓3：
buy TSLA 20 @ 250 [stop:240]   # 风险$200

# 总风险：$1,600 (1.6%) ✅
```

### 3. 止损后不追

```bash
# 原则：止损后冷静，不立即重新入场

# ❌ 错误流程：
buy AAPL 100 @ 150 [stop:145]
# 145止损触发
buy AAPL 100 @ 150 [stop:145]  # 立即再买
# 再次止损...
# 连续亏损

# ✅ 正确流程：
buy AAPL 100 @ 150 [stop:145]
# 145止损触发
# 暂停，分析原因
# 等待更好机会
# 条件满足后重新入场
```

### 4. 保本止损

```bash
# 原则：盈利后移动止损到保本位

# 入场
buy AAPL 100 @ 150 [stop:145]

# 价格涨到155
cancel <stop_id>
sell AAPL 100 STP @ 150 GTC  # 移动到保本

# 优势：
# ✅ 零风险
# ✅ 继续持有等待更大利润
# ✅ 最坏情况：不赚不赔
```

## 实战清单

### 入场前检查清单

- [ ] 确定入场价格
- [ ] 计算止损位置（基于技术位或ATR）
- [ ] 计算止盈位置（至少2:1盈亏比）
- [ ] 确定仓位大小（风险≤1-2%账户）
- [ ] 确认订单类型（AF/LMT/MID）
- [ ] 确认时间参数（GTC/DAY，RTH）

### 订单提交模板

```bash
# 日内交易模板
buy <symbol> <qty> AF @ <price> ± <distance>

# 波段交易模板
buy <symbol> <qty> LMT @ <price> [profit:<target>] [stop:<stop>] GTC RTH

# 快速入场模板（1:1盈亏比）
buy <symbol> <qty> AF @ <price> ± 2
```

### 持仓管理检查清单

- [ ] 定期检查活跃订单（`orders`）
- [ ] 盈利后考虑移动止损到保本
- [ ] 大幅盈利考虑分批止盈
- [ ] 不要随意移动原定止损
- [ ] 记录止损原因以改进策略

## 参考资源

- [订单类型完整指南](ORDER_TYPES.md)
- [GTC和RTH使用详解](GTC_RTH_USAGE.md)
- [快速入门指南](QUICK_START.md)

## 总结

### 核心要点

1. **始终设置止损** - 保护本金是第一要务
2. **合理盈亏比** - 至少2:1，最好3:1+
3. **技术位止损** - 基于支撑/阻力/ATR，不随意
4. **严格执行** - 止损触发立即执行，不犹豫
5. **风险控制** - 单笔≤2%，总持仓≤10%

### 推荐语法

```bash
# 最常用（日内1:1）
buy AAPL 100 AF @ 150 ± 3

# 最推荐（波段2:1+）
buy AAPL 100 LMT @ 150 [profit:+6] [stop:-3] GTC RTH

# 最灵活（跟踪止损）
buy AAPL 100 AF @ 150 [trail:5]
```

记住：**计划你的交易，交易你的计划** - 止盈止损是计划的关键部分！
